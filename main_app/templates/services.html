{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "services_title" %} - {% trans "site_title" %}{% endblock %}

{% block extra_css %}
<style>
.services-hero {
    background: linear-gradient(135deg, #4caf50, #2e7d32);
    color: white;
    padding: 100px 0 50px;
    margin-top: 76px;
    position: relative;
    overflow: hidden;
}

.services-hero::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 50%;
    height: 100%;
    background: url('https://images.unsplash.com/photo-1559136555-9303baea8ebd?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80') center/cover;
    opacity: 0.3;
}

.hero-content {
    position: relative;
    z-index: 2;
}

.hero-content h1 {
    font-size: 36px;
    font-weight: 700;
    margin-bottom: 20px;
}

.promotion-banner {
    background: linear-gradient(45deg, #ff9b10, #f89c1c);
    color: white;
    border-radius: 15px;
    padding: 30px;
    margin: 30px 0;
    box-shadow: 0 10px 30px rgba(248, 156, 28, 0.3);
}

.promotion-banner h3 {
    font-weight: 800;
    font-size: 24px;
    margin-bottom: 10px;
}

.promotion-banner .promo-text {
    font-size: 20px;
    margin-bottom: 15px;
}

.promotion-banner .promo-deadline {
    font-size: 24px;
    font-weight: 800;
    margin-bottom: 20px;
}

.filters-section {
    background: #f8f9fa;
    padding: 40px 0;
}

.filter-card {
    background: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.filter-buttons {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin-bottom: 30px;
}

.filter-btn {
    padding: 12px 24px;
    border-radius: 8px;
    border: 1px solid #1b760a;
    background: white;
    color: #1b760a;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.filter-btn.active {
    background: #1b760a;
    color: white;
}

.filter-btn:hover {
    background: #1b760a;
    color: white;
    transform: translateY(-2px);
}

.categories-section {
    padding: 50px 0;
}

.category-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.category-btn {
    background: #cfe5d9;
    color: #00695c;
    padding: 20px;
    border-radius: 8px;
    text-decoration: none;
    text-align: center;
    font-weight: 500;
    font-size: 14px;
    line-height: 1.3;
    transition: all 0.3s ease;
    min-height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.category-btn.active {
    background: #4caf50;
    color: white;
}

.category-btn:hover {
    background: #4caf50;
    color: white;
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
}

.services-table {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin: 30px 0;
}

.table-header {
    background: #1b760a;
    color: white;
    padding: 20px;
}

.table-header .row > div {
    font-size: 18px;
    font-weight: 600;
    text-align: center;
}

.service-row {
    padding: 20px;
    border-bottom: 1px solid #e0e0e0;
    transition: all 0.3s ease;
}

.service-row:hover {
    background: #f8f9fa;
}

.service-row:last-child {
    border-bottom: none;
}

.service-name {
    font-size: 16px;
    font-weight: 600;
    color: #2e2e2e;
    margin-bottom: 5px;
}

.service-description {
    font-size: 14px;
    color: #555;
    line-height: 1.4;
}

.service-price {
    font-size: 16px;
    font-weight: 600;
    color: #2e2e2e;
    text-align: center;
}

.service-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
}

.btn-consultation {
    background: #2e7d32;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s ease;
}

.btn-consultation:hover {
    background: #1b5e20;
    color: white;
    transform: translateY(-2px);
}

.btn-add-service {
    background: #ff9b10;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
}

.btn-add-service:hover {
    background: #e68910;
    transform: translateY(-2px);
}

.search-section {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.pagination {
    justify-content: center;
    margin-top: 40px;
}

.pagination .page-link {
    color: #1b760a;
    border: 1px solid #1b760a;
    border-radius: 8px;
    margin: 0 5px;
    font-weight: 600;
}

.pagination .page-item.active .page-link {
    background: #1b760a;
    border-color: #1b760a;
}

@media (max-width: 768px) {
    .hero-content h1 {
        font-size: 28px;
    }
    
    .filter-buttons {
        flex-direction: column;
    }
    
    .filter-btn {
        text-align: center;
    }
    
    .category-grid {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
    }
    
    .table-header .row > div {
        font-size: 16px;
    }
    
    .service-actions {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="services-hero">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <div class="hero-content">
                    <h1>{% trans "services_laboratory_analysis" %}</h1>
                    
                    <!-- Promotion Banner -->
                    <div class="promotion-banner">
                        <h3>{% trans "promotion_unprecedented_season" %}</h3>
                        <p class="promo-text">{% trans "promotion_buy_one_get_50_off" %}</p>
                        <p class="promo-deadline">{% trans "promotion_until_july_4" %}</p>
                        <a href="#promotion-details" class="btn btn-light">
                            {% trans "promotion_about" %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Filters Section -->
<section class="filters-section">
    <div class="container">
        <div class="filter-card">
            <h2 class="h4 mb-4">{% trans "services_agrotech_services" %}</h2>
            
            <!-- Provider Filters -->
            <div class="mb-4">
                <h6 class="text-muted mb-3">{% trans "filter_title" %}</h6>
                <div class="filter-buttons">
                    <a href="?provider=all{% if category_filter %}&category={{ category_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" 
                       class="filter-btn {% if not provider_filter or provider_filter == 'all' %}active{% endif %}">
                        {% trans "all_providers" %}
                    </a>
                    {% for provider in providers %}
                        <a href="?provider={{ provider.slug }}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" 
                           class="filter-btn {% if provider_filter == provider.slug %}active{% endif %}">
                            {{ provider.name }}
                        </a>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Search -->
            <div class="search-section">
                <form method="GET" class="row g-3">
                    <div class="col-md-8">
                        <input type="text" name="search" class="form-control" 
                               placeholder="{% trans 'search_services_placeholder' %}" 
                               value="{{ search_query }}">
                        {% if provider_filter %}<input type="hidden" name="provider" value="{{ provider_filter }}">{% endif %}
                        {% if category_filter %}<input type="hidden" name="category" value="{{ category_filter }}">{% endif %}
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-primary w-100">
                            {% trans "search_button" %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

<!-- Categories Section -->
<section class="categories-section">
    <div class="container">
        <h6 class="text-muted mb-3">{% trans "categories_title" %}</h6>
        <div class="category-grid">
            <a href="?category=all{% if provider_filter %}&provider={{ provider_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" 
               class="category-btn {% if not category_filter or category_filter == 'all' %}active{% endif %}">
                {% trans "all_categories" %}
            </a>
            {% for category in categories %}
                <a href="?category={{ category.slug }}{% if provider_filter %}&provider={{ provider_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" 
                   class="category-btn {% if category_filter == category.slug %}active{% endif %}">
                    {{ category.name }}
                </a>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Services Table Section -->
<section class="services-table-section">
    <div class="container">
        {% if page_obj %}
            <div class="services-table">
                <!-- Table Header -->
                <div class="table-header">
                    <div class="row">
                        <div class="col-md-3">{% trans "service_name" %}</div>
                        <div class="col-md-4">{% trans "service_description" %}</div>
                        <div class="col-md-2">{% trans "service_price_tenge" %}</div>
                        <div class="col-md-3">{% trans "service_actions" %}</div>
                    </div>
                </div>
                
                <!-- Services Rows -->
                {% for service in page_obj %}
                    <div class="service-row">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <div class="service-name">{{ service.name }}</div>
                                {% if service.duration %}
                                    <small class="text-muted">{{ service.duration }}</small>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <div class="service-description">
                                    {{ service.short_description|default:service.description|truncatewords:20 }}
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="service-price">
                                    {{ service.price|floatformat:0 }}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="service-actions">
                                    <a href="#" class="btn-consultation" 
                                       onclick="openConsultationModal({{ service.id }}, '{{ service.name }}')">
                                        {% trans "consultation" %}
                                    </a>
                                    <button type="button" class="btn-add-service" 
                                            onclick="addToCart({{ service.id }}, '{{ service.name }}', {{ service.price }})">
                                        <i class="fas fa-shopping-cart"></i>
                                        {% trans "add_service" %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
                <nav aria-label="Services pagination">
                    <ul class="pagination">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if provider_filter %}&provider={{ provider_filter }}{% endif %}">
                                    {% trans "previous" %}
                                </a>
                            </li>
                        {% endif %}
                        
                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if provider_filter %}&provider={{ provider_filter }}{% endif %}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if provider_filter %}&provider={{ provider_filter }}{% endif %}">
                                    {% trans "next" %}
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        {% else %}
            <div class="text-center py-5">
                <h3>{% trans "no_services_found" %}</h3>
                <p>{% trans "try_different_filters" %}</p>
            </div>
        {% endif %}
    </div>
</section>

<!-- Consultation Modal -->
<div class="modal fade" id="consultationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "consultation_request" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="consultationForm">
                    {% csrf_token %}
                    <input type="hidden" id="serviceId" name="service_id">
                    
                    <div class="mb-3">
                        <label class="form-label">{% trans "service_name" %}</label>
                        <input type="text" id="serviceName" class="form-control" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="clientName" class="form-label">{% trans "client_name" %}</label>
                        <input type="text" class="form-control" id="clientName" name="client_name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="clientEmail" class="form-label">{% trans "client_email" %}</label>
                        <input type="email" class="form-control" id="clientEmail" name="client_email" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="clientPhone" class="form-label">{% trans "client_phone" %}</label>
                        <input type="tel" class="form-control" id="clientPhone" name="client_phone" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="message" class="form-label">{% trans "message" %}</label>
                        <textarea class="form-control" id="message" name="message" rows="3"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">
                        {% trans "send_request" %}
                    </button>
                </form>
                <div id="consultationMessage" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Cart functionality (placeholder)
let cart = [];

function addToCart(serviceId, serviceName, price) {
    cart.push({
        id: serviceId,
        name: serviceName,
        price: price
    });
    
    // Show success message
    alert('{% trans "service_added_to_cart" %}: ' + serviceName);
    
    // Update cart counter (if exists)
    updateCartCounter();
}

function updateCartCounter() {
    const counter = document.querySelector('.cart-counter');
    if (counter) {
        counter.textContent = cart.length;
    }
}

// Consultation modal
function openConsultationModal(serviceId, serviceName) {
    document.getElementById('serviceId').value = serviceId;
    document.getElementById('serviceName').value = serviceName;
    
    const modal = new bootstrap.Modal(document.getElementById('consultationModal'));
    modal.show();
}

// Consultation form submission
document.getElementById('consultationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('{% url "service_request" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        const messageDiv = document.getElementById('consultationMessage');
        if (data.success) {
            messageDiv.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
            this.reset();
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('consultationModal')).hide();
            }, 2000);
        } else {
            messageDiv.innerHTML = '<div class="alert alert-danger">' + data.message + '</div>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        const messageDiv = document.getElementById('consultationMessage');
        messageDiv.innerHTML = '<div class="alert alert-danger">{% trans "request_error" %}</div>';
    });
});

// Smooth scrolling for anchor links
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            target.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
    });
});
</script>
{% endblock %}